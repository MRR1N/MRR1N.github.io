<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { getDatabase, ref, onValue, set } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyDyhtt2puz5oAO-PKFTr4D1FwWVFs9_7e4",
  authDomain: "mrr1n-reviews.firebaseapp.com",
  databaseURL: "https://mrr1n-reviews-default-rtdb.firebaseio.com",
  projectId: "mrr1n-reviews",
  storageBucket: "mrr1n-reviews.firebasestorage.app",
  messagingSenderId: "353253143876",
  appId: "1:353253143876:web:acf7171dceb5a306955311"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const ageModal = document.getElementById('ageModal');
const modalText = document.getElementById('modalText');
const adultYesBtn = document.getElementById('adult-yes');
const adultNoBtn = document.getElementById('adult-no');
if(localStorage.getItem('adultConfirmed')==='true') ageModal.style.display='none';
adultYesBtn.addEventListener('click',()=>{localStorage.setItem('adultConfirmed','true');ageModal.style.display='none';});
adultNoBtn.addEventListener('click',()=>{modalText.textContent='Refresh the page to try again';adultYesBtn.style.display='none';adultNoBtn.style.display='none';document.querySelector('#modalContent img').src='sprite2.png';});

function switchLang(l){
  const h = document.getElementById('header-desc'), p = document.getElementById('pricing-title'), r = document.getElementById('reviews-title');
  const n = document.getElementById('nickname'), t = document.getElementById('review');
  const b = document.querySelector('#review-write button'), tos = document.querySelector('.tos-toggle');
  if(l==='ru'){
    h.textContent='2D Ğ¤ÑƒÑ€Ñ€Ğ¸ Ñ…ÑƒĞ´Ğ¾Ğ¶Ğ½Ğ¸Ğº Ğ¸ Ğ°Ğ½Ğ¸Ğ¼Ğ°Ñ‚Ğ¾Ñ€';
    p.textContent='ĞŸÑ€Ğ°Ğ¹Ñ-Ğ»Ğ¸ÑÑ‚';
    r.textContent='ĞÑ‚Ğ·Ñ‹Ğ²Ñ‹';
    n.placeholder='ĞĞ¸ĞºĞ½ĞµĞ¹Ğ¼';
    t.placeholder='Ğ’Ğ°Ñˆ Ğ¾Ñ‚Ğ·Ñ‹Ğ²';
    b.textContent='ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ¸Ñ‚ÑŒ';
    n.setCustomValidity('Ğ—Ğ°Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚Ğµ ÑÑ‚Ğ¾ Ğ¿Ğ¾Ğ»Ğµ');
    t.setCustomValidity('Ğ—Ğ°Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚Ğµ ÑÑ‚Ğ¾ Ğ¿Ğ¾Ğ»Ğµ');
    tos.textContent='Ğ£ÑĞ»Ğ¾Ğ²Ğ¸Ñ *Ğ½Ğ°Ğ¶Ğ¼Ğ¸Ñ‚Ğµ, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ñ€Ğ°Ğ·Ğ²ĞµÑ€Ğ½ÑƒÑ‚ÑŒ';
    document.getElementById('pricing-content-en').style.display='none';
    document.getElementById('pricing-content-ru').style.display='flex';
    document.getElementById('pricing-content-es').style.display='none';
  } else if(l==='es'){
    h.textContent='Artista y Animador Furry 2D';
    p.textContent='Precios';
    r.textContent='ReseÃ±as (haz clic para dejar la tuya)';
    n.placeholder='Apodo';
    t.placeholder='Tu reseÃ±a';
    b.textContent='Enviar reseÃ±a';
    n.setCustomValidity('Por favor, complete este campo');
    t.setCustomValidity('Por favor, complete este campo');
    tos.textContent='TÃ©rminos de Servicio (clic para expandir)';
    document.getElementById('pricing-content-en').style.display='none';
    document.getElementById('pricing-content-ru').style.display='none';
    document.getElementById('pricing-content-es').style.display='flex';
  } else {
    h.textContent='2D Furry Artist & Animator';
    p.textContent='Pricing';
    r.textContent='Reviews *click';
    n.placeholder='Nickname';
    t.placeholder='Your review';
    b.textContent='Submit';
    n.setCustomValidity('Please fill out this field');
    t.setCustomValidity('Please fill out this field');
    tos.textContent='TOS (Click to expand)';
    document.getElementById('pricing-content-en').style.display='flex';
    document.getElementById('pricing-content-ru').style.display='none';
    document.getElementById('pricing-content-es').style.display='none';
  }
}

document.getElementById('btn-en').addEventListener('click',()=>switchLang('en'));
document.getElementById('btn-ru').addEventListener('click',()=>switchLang('ru'));
document.getElementById('btn-es').addEventListener('click',()=>switchLang('es'));

const reviewsList = document.getElementById('existing-reviews');
function loadReviews() {
  const reviewsRef = ref(db, 'reviews');
  onValue(reviewsRef, snapshot => {
    const data = snapshot.val() || [];
    reviewsList.innerHTML = '';
    data.forEach((e, i) => {
      const d = document.createElement('div');
      d.className = 'review-item';
      if (sessionStorage.getItem('admin') === 'true') {
        d.innerHTML = `<div class='review-avatar'>ğŸ¾</div><strong>${e.nickname}:</strong> <span>${e.text}</span> <button class='delete-btn' data-index='${i}'>âœ–</button>`;
      } else {
        d.innerHTML = `<div class='review-avatar'>ğŸ¾</div><strong>${e.nickname}:</strong> <span>${e.text}</span>`;
      }
      reviewsList.appendChild(d);
    });
  });
}

function submitReview(e) {
  e.preventDefault();
  const nickname = document.getElementById('nickname');
  const review = document.getElementById('review');
  if (!nickname.value.trim()) { nickname.setCustomValidity('Ğ—Ğ°Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚Ğµ ÑÑ‚Ğ¾ Ğ¿Ğ¾Ğ»Ğµ'); nickname.reportValidity(); return; } else nickname.setCustomValidity('');
  if (!review.value.trim()) { review.setCustomValidity('Ğ—Ğ°Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚Ğµ ÑÑ‚Ğ¾ Ğ¿Ğ¾Ğ»Ğµ'); review.reportValidity(); return; } else review.setCustomValidity('');

  const reviewsRef = ref(db, 'reviews');
  onValue(reviewsRef, snapshot => {
    const data = snapshot.val() || [];
    data.push({ nickname: nickname.value, text: review.value });
    set(reviewsRef, data).then(() => { nickname.value = ''; review.value = ''; });
  }, { onlyOnce: true });
}

reviewsList.addEventListener('click', e => {
  if (e.target.classList.contains('delete-btn') && sessionStorage.getItem('admin') === 'true') {
    const index = e.target.dataset.index;
    const reviewsRef = ref(db, 'reviews');
    onValue(reviewsRef, snapshot => {
      const data = snapshot.val() || [];
      data.splice(index, 1);
      set(reviewsRef, data);
    }, { onlyOnce: true });
  }
});

function toggleReviewForm() {
  const r = document.getElementById('review-write');
  r.style.maxHeight = r.style.maxHeight && r.style.maxHeight !== '0px' ? '0' : r.scrollHeight + 'px';
}

function toggleTOS() {
  const t = document.getElementById('tos-content');
  t.style.maxHeight = t.style.maxHeight && t.style.maxHeight !== '0px' ? '0' : t.scrollHeight + 'px';
}

loadReviews();

const ADMIN_HASH = "4a00129cbb22404def25ed8d43039b4567279b9de244537af43c3b9166214b71";

async function sha256(s) {
  const b = new TextEncoder().encode(s);
  const h = await crypto.subtle.digest("SHA-256", b);
  return [...new Uint8Array(h)].map(x => x.toString(16).padStart(2, "0")).join("");
}

document.addEventListener("keydown", async e => {
  if (e.ctrlKey && e.shiftKey && e.code === "Digit8") {
    const p = prompt("Enter admin password:");
    if (!p) return;
    const hash = await sha256(p.trim());
    if (hash === ADMIN_HASH) {
      sessionStorage.setItem("admin", "true");
      loadReviews();
      alert("Admin mode enabled");
    } else {
      alert("Wrong password");
    }
  }
});
</script>
